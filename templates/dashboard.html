<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MedTrackr</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">MedTrackr</div>
        <div class="nav-links">
            <a href="{{ url_for('logout') }}" class="btn btn-outline">Logout</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h3>{{ current_user.name }}</h3>
                <p>{{ current_user.email }}</p>
                <div class="phone-number-section">
                    <input type="tel" id="phoneNumber" placeholder="Enter phone number (e.g., +1234567890)" value="{{ current_user.phone_number or '' }}" class="phone-input" pattern="[+]?[0-9]{10,15}">
                    <button onclick="updatePhoneNumber()" class="btn btn-sm btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                <p class="sms-notice">Add your phone number to receive SMS reminders</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#medications" class="active">
                    <i class="fas fa-pills"></i> Medications
                </a>
                <a href="#prescriptions">
                    <i class="fas fa-file-medical"></i> Prescriptions
                </a>
                <a href="#reminders">
                    <i class="fas fa-bell"></i> Reminders
                </a>
                <a href="#reports">
                    <i class="fas fa-chart-bar"></i> Reports
                </a>
                <a href="#settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>
        </aside>

        <main class="dashboard-content">
            <section id="medications" class="dashboard-section">
                <div class="section-header">
                    <h2>My Medications</h2>
                    <button class="btn btn-primary" onclick="showAddMedicationModal()">
                        <i class="fas fa-plus"></i> Add Medication
                    </button>
                </div>
                
                <div class="medication-grid">
                    {% if medications %}
                        {% for medication in medications %}
                        <div class="medication-card" data-medication-id="{{ medication.id }}">
                            <div class="medication-info">
                                <h3>{{ medication.name }}</h3>
                                <p>{{ medication.dosage }} - {{ medication.frequency }}</p>
                                {% if medication.reminder_time %}
                                    <p class="medication-status">Next dose: {{ medication.reminder_time.strftime('%I:%M %p') }}</p>
                                {% endif %}
                                <p class="medication-date">Started: {{ medication.start_date.strftime('%B %d, %Y') }}</p>
                            </div>
                            <div class="medication-actions">
                                <button class="btn-icon" title="Edit" onclick="editMedication({{ medication.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" title="Delete" onclick="deleteMedication({{ medication.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-medications">
                            <p>No medications found. Add your first medication to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </section>

            <section id="prescriptions" class="dashboard-section">
                <div class="section-header">
                    <h2>Prescriptions</h2>
                    <button class="btn btn-primary" onclick="showUploadPrescriptionModal()">
                        <i class="fas fa-upload"></i> Upload Prescription
                    </button>
                </div>
                
                <div class="prescription-grid">
                    {% if prescriptions %}
                        {% for prescription in prescriptions %}
                        <div class="prescription-card">
                            <div class="prescription-info">
                                <h3>{{ prescription.doctor_name }}</h3>
                                <p>Date: {{ prescription.date_prescribed.strftime('%B %d, %Y') }}</p>
                                {% if prescription.image_path %}
                                    <p>Status: <span class="status-active">Active</span></p>
                                {% else %}
                                    <p>Status: <span class="status-pending">Pending</span></p>
                                {% endif %}
                                {% if prescription.notes %}
                                    <p class="prescription-notes">{{ prescription.notes }}</p>
                                {% endif %}
                            </div>
                            <div class="prescription-actions">
                                {% if prescription.image_path %}
                                    <button class="btn-icon" title="View" onclick="viewPrescription('{{ prescription.image_path }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-icon" title="Download" onclick="downloadPrescription('{{ prescription.image_path }}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                {% endif %}
                                <button class="btn-icon" title="Delete" onclick="deletePrescription({{ prescription.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-prescriptions">
                            <p>No prescriptions found. Upload your first prescription to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </section>

            <!-- Add this section after the prescriptions section -->
            <section id="reminders" class="dashboard-section">
                <div class="section-header">
                    <h2>Pending Reminders</h2>
                </div>
                <div class="reminders-container">
                    <div id="pendingReminders" class="reminders-list">
                        <!-- Pending reminders will be added here dynamically -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Medication Modal -->
    <div id="addMedicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Medication</h3>
                <button class="close-modal" onclick="closeModal('addMedicationModal')">&times;</button>
            </div>
            <form id="addMedicationForm">
                <div class="form-group">
                    <label for="medicationName">Medication Name</label>
                    <input type="text" id="medicationName" required>
                </div>
                <div class="form-group">
                    <label for="dosage">Dosage</label>
                    <input type="text" id="dosage" required>
                </div>
                <div class="form-group">
                    <label for="frequency">Frequency</label>
                    <select id="frequency" required>
                        <option value="once">Once daily</option>
                        <option value="twice">Twice daily</option>
                        <option value="thrice">Three times daily</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reminderTime">Reminder Time</label>
                    <input type="time" id="reminderTime" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Medication</button>
            </form>
        </div>
    </div>

    <!-- Upload Prescription Modal -->
    <div id="uploadPrescriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Prescription</h3>
                <button class="close-modal" onclick="closeModal('uploadPrescriptionModal')">&times;</button>
            </div>
            <form id="uploadPrescriptionForm">
                <div class="form-group">
                    <label for="doctorName">Doctor's Name</label>
                    <input type="text" id="doctorName" required>
                </div>
                <div class="form-group">
                    <label for="prescriptionDate">Date Prescribed</label>
                    <input type="date" id="prescriptionDate" required>
                </div>
                <div class="form-group">
                    <label for="prescriptionImage">Upload Image</label>
                    <input type="file" id="prescriptionImage" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Upload Prescription</button>
            </form>
        </div>
    </div>

    <style>
        :root {
            --royal-blue: #1a237e;
            --royal-purple: #4a148c;
            --royal-gold: #ffd700;
            --royal-silver: #e0e0e0;
            --royal-white: #ffffff;
            --royal-dark: #0d0d0d;
            --royal-accent: #7c4dff;
            --royal-success: #00c853;
            --royal-warning: #ffd600;
            --royal-error: #d50000;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: var(--royal-dark);
        }

        .navbar {
            background: linear-gradient(135deg, var(--royal-blue), var(--royal-purple));
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-brand {
            color: var(--royal-white);
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-links .btn-outline {
            border: 2px solid var(--royal-gold);
            color: var(--royal-gold);
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .nav-links .btn-outline:hover {
            background-color: var(--royal-gold);
            color: var(--royal-blue);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
            padding-top: 60px;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--royal-blue), var(--royal-purple));
            color: var(--royal-white);
            padding: 2rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--royal-gold);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .sidebar-nav a {
            color: var(--royal-white);
            text-decoration: none;
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-nav a i {
            width: 24px;
            text-align: center;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .dashboard-content {
            flex: 1;
            padding: 2rem;
            background-color: #f8fafc;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--royal-silver);
        }

        .section-header h2 {
            color: var(--royal-blue);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--royal-blue), var(--royal-purple));
            color: var(--royal-white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .medication-grid,
        .prescription-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .medication-card,
        .prescription-card {
            background: var(--royal-white);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid var(--royal-silver);
        }

        .medication-card:hover,
        .prescription-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .medication-info h3,
        .prescription-info h3 {
            color: var(--royal-blue);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .medication-status {
            color: var(--royal-success);
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            background: rgba(0, 200, 83, 0.1);
            border-radius: 15px;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--royal-blue);
            cursor: pointer;
            padding: 0.5rem;
            transition: all 0.3s ease;
            border-radius: 50%;
        }

        .btn-icon:hover {
            background: rgba(26, 35, 126, 0.1);
            color: var(--royal-purple);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--royal-white);
            width: 90%;
            max-width: 500px;
            margin: 2rem auto;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--royal-blue);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--royal-silver);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--royal-accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
        }

        .medication-reminder {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--royal-blue), var(--royal-purple));
            color: var(--royal-white);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .reminder-content {
            text-align: center;
            padding: 0.5rem;
        }

        .reminder-content h4 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            color: var(--royal-gold);
            font-weight: 600;
        }

        .reminder-content p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            color: var(--royal-white);
        }

        .reminder-content button {
            margin-top: 1rem;
            background-color: var(--royal-gold);
            color: var(--royal-blue);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
            display: inline-block;
            text-align: center;
            font-size: 1rem;
        }

        .reminder-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            background-color: #ffea00;
        }

        .no-medications,
        .no-prescriptions {
            text-align: center;
            padding: 3rem;
            background: var(--royal-white);
            border-radius: 15px;
            color: var(--royal-blue);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .no-medications p,
        .no-prescriptions p {
            font-size: 1.1rem;
            margin: 0;
            color: var(--royal-purple);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 2rem;
            border-radius: 10px;
            color: var(--royal-white);
            font-weight: 500;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: linear-gradient(135deg, var(--royal-success), #00e676);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--royal-error), #ff1744);
        }

        /* Add these styles to your existing CSS */
        .reminders-container {
            background: var(--royal-white);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .reminders-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .reminder-item {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.05), rgba(74, 20, 140, 0.05));
            border: 1px solid var(--royal-silver);
            border-radius: 10px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .reminder-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-info h4 {
            color: var(--royal-blue);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .reminder-info p {
            color: var(--royal-purple);
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .reminder-time {
            color: var(--royal-success);
            font-weight: 500;
        }

        .reminder-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .reminder-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 140px;
            justify-content: center;
        }

        .reminder-actions .btn-taken {
            background: var(--royal-success);
            color: white;
        }

        .reminder-actions .btn-taken:hover {
            background: #00e676;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
        }

        .reminder-actions .btn-snooze {
            background: var(--royal-warning);
            color: var(--royal-dark);
        }

        .reminder-actions .btn-snooze:hover {
            background: #ffea00;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .no-reminders {
            text-align: center;
            padding: 2rem;
            color: var(--royal-purple);
            font-style: italic;
        }

        .phone-number-section {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            width: 100%;
        }

        .phone-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--royal-silver);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .phone-input:focus {
            border-color: var(--royal-accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
        }

        .phone-input:invalid {
            border-color: var(--royal-error);
        }

        .btn-sm {
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .btn-sm:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .sms-notice {
            font-size: 0.85rem;
            color: var(--royal-purple);
            margin-top: 0.5rem;
            font-style: italic;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }
    </style>

    <script>
        let reminderCheckInterval;
        let lastCheckedTimes = new Map();
        let activeReminders = new Map(); // Changed to Map to store both notification and audio elements

        function startReminderChecks() {
            console.log('Starting reminder checks...');
            // Check for reminders every 10 seconds
            reminderCheckInterval = setInterval(checkMedicationReminders, 10000);
            // Also check immediately when the page loads
            checkMedicationReminders();
        }

        function checkMedicationReminders() {
            console.log('Checking medication reminders...');
            const medicationCards = document.querySelectorAll('.medication-card');
            console.log(`Found ${medicationCards.length} medication cards`);
            
            medicationCards.forEach(card => {
                const medicationId = card.getAttribute('data-medication-id');
                const lastChecked = lastCheckedTimes.get(medicationId) || 0;
                const currentTime = new Date().getTime();
                
                // Only check if we haven't checked in the last 20 seconds
                if (currentTime - lastChecked > 20000) {
                    console.log(`Checking reminder for medication ${medicationId}`);
                    checkMedicationReminder(medicationId);
                    lastCheckedTimes.set(medicationId, currentTime);
                }
            });
        }

        function checkMedicationReminder(medicationId) {
            // Skip if we already have an active reminder for this medication
            if (activeReminders.has(medicationId)) {
                console.log(`Skipping check for medication ${medicationId} - already has active reminder`);
                return;
            }

            fetch(`/medication/${medicationId}/reminder`)
                .then(response => response.json())
                .then(data => {
                    console.log(`Reminder check response for medication ${medicationId}:`, data);
                    if (data.success) {
                        console.log(`Showing reminder for medication ${medicationId}`);
                        showMedicationReminder(data.medication);
                    }
                })
                .catch(error => {
                    console.error('Error checking reminder:', error);
                });
        }

        function showMedicationReminder(medication) {
            console.log('Showing medication reminder:', medication);
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'medication-reminder';
            notification.setAttribute('data-medication-id', medication.id);
            notification.innerHTML = `
                <div class="reminder-content">
                    <h4>Time to take your medication!</h4>
                    <p>${medication.name} - ${medication.dosage}</p>
                    <p>Frequency: ${medication.frequency}</p>
                    <p>Reminder Time: ${medication.reminder_time}</p>
                    <button onclick="markMedicationTaken(${medication.id})" class="btn-taken">
                        <i class="fas fa-check"></i> Mark as Taken
                    </button>
                </div>
            `;
            
            // Add notification to the page
            document.body.appendChild(notification);
            console.log('Reminder notification added to page');
            
            // Create and play notification sound
            const audio = new Audio('/static/sounds/notification.mp3');
            audio.volume = 1.0;
            audio.loop = true;
            
            // Store both notification and audio elements
            activeReminders.set(medication.id, {
                notification: notification,
                audio: audio,
                medication: medication
            });
            
            // Play notification sound
            try {
                console.log('Playing notification sound');
                audio.play().catch(error => {
                    console.error('Error playing notification sound:', error);
                });
            } catch (error) {
                console.error('Error creating audio element:', error);
            }
            
            // Show system notification
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Medication Reminder', {
                        body: `Time to take ${medication.name} - ${medication.dosage}`,
                        icon: '/static/images/logo.png'
                    });
                }
            }
            
            // Update pending reminders list
            updatePendingReminders();
            
            // Remove notification after 5 minutes if not dismissed
            setTimeout(() => {
                const reminder = activeReminders.get(medication.id);
                if (reminder) {
                    if (reminder.notification.parentNode) {
                        reminder.notification.remove();
                    }
                    reminder.audio.pause();
                    reminder.audio.currentTime = 0;
                    activeReminders.delete(medication.id);
                    updatePendingReminders();
                }
            }, 300000);
        }

        function markMedicationTaken(medicationId) {
            console.log(`Marking medication ${medicationId} as taken`);
            
            // First, stop the reminder and sound
            const reminder = activeReminders.get(medicationId);
            if (reminder) {
                // Stop and reset the audio
                reminder.audio.pause();
                reminder.audio.currentTime = 0;
                // Remove the notification
                if (reminder.notification.parentNode) {
                    reminder.notification.remove();
                }
                // Remove from active reminders
                activeReminders.delete(medicationId);
                // Update pending reminders list
                updatePendingReminders();
            }

            // Then send the request to mark as taken
            fetch(`/medication/${medicationId}/taken`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Medication marked as taken successfully');
                    showNotification('Medication marked as taken');
                } else {
                    showNotification(data.error || 'Error marking medication as taken', 'error');
                }
            })
            .catch(error => {
                console.error('Error marking medication as taken:', error);
                showNotification('Error marking medication as taken', 'error');
            });
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            startReminderChecks();
            updatePendingReminders(); // Initial update of pending reminders
        });

        function showAddMedicationModal() {
            document.getElementById('addMedicationModal').style.display = 'block';
        }

        function showUploadPrescriptionModal() {
            document.getElementById('uploadPrescriptionModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        document.getElementById('addMedicationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('medicationName', document.getElementById('medicationName').value);
            formData.append('dosage', document.getElementById('dosage').value);
            formData.append('frequency', document.getElementById('frequency').value);
            formData.append('reminderTime', document.getElementById('reminderTime').value);
            
            fetch('/add_medication', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const medicationCard = createMedicationCard(data.medication);
                    
                    const grid = document.querySelector('.medication-grid');
                    const noMedicationsMsg = grid.querySelector('.no-medications');
                    if (noMedicationsMsg) {
                        noMedicationsMsg.remove();
                    }
                    grid.insertBefore(medicationCard, grid.firstChild);
                    
                    closeModal('addMedicationModal');
                    document.getElementById('addMedicationForm').reset();
                    
                    showNotification('Medication added successfully');
                } else {
                    showNotification(data.error || 'Error adding medication', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding medication', 'error');
            });
        });

        function createMedicationCard(medication) {
            const card = document.createElement('div');
            card.className = 'medication-card';
            card.setAttribute('data-medication-id', medication.id);
            
            card.innerHTML = `
                <div class="medication-info">
                    <h3>${medication.name}</h3>
                    <p>${medication.dosage} - ${medication.frequency}</p>
                    ${medication.reminder_time ? 
                        `<p class="medication-status">Next dose: ${medication.reminder_time}</p>` : ''}
                    <p class="medication-date">Started: ${medication.start_date}</p>
                </div>
                <div class="medication-actions">
                    <button class="btn-icon" title="Edit" onclick="editMedication(${medication.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" title="Delete" onclick="deleteMedication(${medication.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function deleteMedication(medicationId) {
            if (confirm('Are you sure you want to delete this medication?')) {
                fetch(`/medication/${medicationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the medication card from the DOM
                        const card = document.querySelector(`.medication-card[data-medication-id="${medicationId}"]`);
                        if (card) {
                            card.remove();
                            
                            // Check if there are any medications left
                            const remainingCards = document.querySelectorAll('.medication-card');
                            if (remainingCards.length === 0) {
                                // If no medications left, show the "no medications" message
                                const grid = document.querySelector('.medication-grid');
                                const noMedicationsMsg = document.createElement('div');
                                noMedicationsMsg.className = 'no-medications';
                                noMedicationsMsg.innerHTML = '<p>No medications found. Add your first medication to get started!</p>';
                                grid.appendChild(noMedicationsMsg);
                            }
                        }
                        showNotification('Medication deleted successfully');
                    } else {
                        showNotification(data.error || 'Error deleting medication', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error deleting medication', 'error');
                });
            }
        }

        function updatePendingReminders() {
            const pendingReminders = document.getElementById('pendingReminders');
            const activeRemindersList = Array.from(activeReminders.entries());
            
            if (activeRemindersList.length === 0) {
                pendingReminders.innerHTML = '<div class="no-reminders">No pending reminders</div>';
                return;
            }

            pendingReminders.innerHTML = activeRemindersList.map(([id, reminder]) => `
                <div class="reminder-item" data-medication-id="${id}">
                    <div class="reminder-info">
                        <h4>${reminder.medication.name}</h4>
                        <p>${reminder.medication.dosage}</p>
                        <p class="reminder-time">Reminder Time: ${reminder.medication.reminder_time}</p>
                    </div>
                    <div class="reminder-actions">
                        <button class="btn-snooze" onclick="snoozeReminder(${id})">
                            <i class="fas fa-clock"></i> Snooze
                        </button>
                        <button class="btn-taken" onclick="markMedicationTaken(${id})">
                            <i class="fas fa-check"></i> Mark as Taken
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function snoozeReminder(medicationId) {
            const reminder = activeReminders.get(medicationId);
            if (reminder) {
                // Stop current reminder
                reminder.audio.pause();
                reminder.audio.currentTime = 0;
                if (reminder.notification.parentNode) {
                    reminder.notification.remove();
                }
                activeReminders.delete(medicationId);

                // Schedule new reminder in 2 minutes
                setTimeout(() => {
                    checkMedicationReminder(medicationId);
                }, 120000); // 2 minutes

                showNotification('Reminder snoozed for 2 minutes');
                updatePendingReminders();
            }
        }

        function updatePhoneNumber() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            // Validate phone number format
            if (!phoneNumber.match(/^[+]?[0-9]{10,15}$/)) {
                showNotification('Please enter a valid phone number (e.g., +1234567890)', 'error');
                return;
            }
            
            // Show loading state
            const saveButton = document.querySelector('.phone-number-section button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveButton.disabled = true;
            
            fetch('/update_phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone_number: phoneNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Phone number updated successfully');
                    // Update the input field with the saved value
                    document.getElementById('phoneNumber').value = phoneNumber;
                } else {
                    showNotification(data.error || 'Error updating phone number', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating phone number', 'error');
            })
            .finally(() => {
                // Reset button state
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            });
        }

        // Add input validation
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            const value = e.target.value;
            // Remove any non-digit characters except the plus sign
            const cleaned = value.replace(/[^\d+]/g, '');
            // Ensure only one plus sign at the start
            const formatted = cleaned.startsWith('+') ? '+' + cleaned.slice(1).replace(/\+/g, '') : cleaned;
            e.target.value = formatted;
        });
    </script>
</body>
</html>